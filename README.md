# Solanaå…¨ç«¯é–‹ç™¼

é€™æ˜¯åŸºæ–¼[é€™ç¯‡](https://dev.to/dabit3/the-complete-guide-to-full-stack-solana-development-with-react-anchor-rust-and-phantom-3291)åšçš„ä¸€äº›æ¿ƒç¸®æ•´ç†ã€‚

## å°ˆæ¡ˆæ¦‚è¿°

é€™å€‹æ‡‰ç”¨æœƒç”¨åˆ°ä»¥ä¸‹çš„å·¥å…·

### [Solana Tool Suite](https://docs.solana.com/cli/install-solana-cli-tools)

é€™æ˜¯Solanaå®˜æ–¹çš„å·¥å…·ï¼Œè£¡é¢æŠŠå¸¸ç”¨çš„æŒ‡ä»¤éƒ½åŒ…è£å¥½äº†ã€‚

### [Anchor Framework](https://project-serum.github.io/anchor/getting-started/introduction.html)

Anchorå°±åƒæ˜¯Hardhat,Truffleé€™é¡çš„å·¥å…·ã€‚ä»–é‚„åœ¨Rustçš„æ›´ä¸Šå±¤æä¾›äº†DSLï¼Œè®“ä½ å¯ä»¥åœ¨ä¸æ˜¯å¾ˆç†Ÿæ‚‰Rustçš„åŒæ™‚ä¹Ÿèƒ½é–‹å§‹é–‹ç™¼ï¼ä½†ä¹Ÿæ˜¯æ»¿å»ºè­°èƒ½åœ¨æœ‰ç©ºä¹‹æ–¼å­¸ç¿’ä¸€ä¸‹Rustï¼Œé€™é‚Šæœ‰ä¸€å€‹[æ»¿å¥½çš„åœ°æ–¹å¯ä»¥å­¸ç¿’](https://doc.rust-lang.org/book/title-page.html)

### [solana/web3.js](https://solana-labs.github.io/solana-web3.js/)

å°±æ˜¯Solanaç‰ˆæœ¬çš„[web3.js](https://web3js.readthedocs.io)ï¼Œå¦å¤–æˆ‘æœ‰ä¸€ç¯‡[solana-web3-demo](https://github.com/yihau/solana-web3-demo)å¯ä»¥æ­é…ä½¿ç”¨ã€‚

### [React](https://reactjs.org/)

ç„¡é ˆå¤šåšä»‹ç´¹ï¼Œå¾ˆç†±é–€çš„å‰ç«¯æ¡†æ¶ã€‚

é€™é‚Šæœƒä¸»è¦å°ˆæ³¨åœ¨é–‹ç™¼è€Œä¸æœƒå°Solanaé€²è¡Œå¤ªæ·±å…¥åœ°è¬›è§£ã€‚ä½†å¦‚æœä½ æƒ³è¦æ›´äº†è§£Solanaçš„è©±ï¼Œå¯ä»¥åƒè€ƒä¸‹é¢å¹¾ç¯‡

- [Solana Docs Introduction](https://docs.solana.com/introduction)
- [ok so what the fuck is the deal with solana anyway](https://2501babe.github.io/posts/solana101.html)
- [Solana Summer](https://www.notboring.co/p/solana-summer)

ä»¥ä¸Šæ˜¯åŸä½œè€…åˆ—èˆ‰çš„æ–‡ç« ï¼Œæˆ‘è‡ªå·±å‰‡æ˜¯éå¸¸æ¨è–¦ä¸€å®šè¦è®€æ‡‚[Programming Model](https://docs.solana.com/developing/programming-model/overview)ï¼Œå› ç‚ºSolanaçš„Accountæ©Ÿåˆ¶å’ŒEthereuméå¸¸ä¸ä¸€æ¨£ï¼Œæœƒéœ€è¦ä¸€äº›æ™‚é–“ç¿’æ…£ã€‚è€Œé€™ç¯‡è£¡é¢æ‰€è¬›çš„æ±è¥¿åœ¨é–‹ç™¼ä»»ä½•Solanaæ‡‰ç”¨éƒ½æœƒç”¨åˆ°ã€‚

å¦å¤–å¦‚æœæ˜¯æœ‰æƒ³è¦é—œæ³¨NFTé–‹ç™¼çš„äººï¼Œå¯ä»¥é—œæ³¨[Metaplex](https://www.metaplex.com/)

## æº–å‚™

åœ¨é–‹å§‹å‰å¯èƒ½æœƒéœ€è¦é å…ˆå®‰è£ä¸€äº›æ±è¥¿

1. Node.js (æ¨è–¦ä½¿ç”¨nvmæˆ–æ˜¯fnmä¾†å®‰è£)
2. Solana Tool Suite ([é€™è£¡](https://docs.solana.com/cli/install-solana-cli-tools)æœ‰å®‰è£èªªæ˜ï¼Œå¦å¤–å¦‚æœæ˜¯M1çš„è©±ï¼Œå¯ä»¥åƒè€ƒ[é€™è£¡](https://github.com/project-serum/anchor/issues/95#issuecomment-913090162))
3. Anchor ([é€™è£¡](https://project-serum.github.io/anchor/getting-started/installation.html#install-rust)æœ‰å®‰è£æ­¥é©Ÿ)
4. Solana browser wallet (æ¨è–¦ä½¿ç”¨[Phontom](https://phantom.app/))

## é–‹å§‹

### Solana CLI

```sh
solana config get
```

é€™å¯ä»¥çœ‹ä¸€ä¸‹ç•¶å‰solana cliå·¥å…·çš„configè¨­å®šã€‚å¦‚æœä½ é‚„æ²’æœ‰è¨­ç½®keyçš„è©±å¯ä»¥ä¾†[é€™è£¡](https://docs.solana.com/wallet-guide/paper-wallet#seed-phrase-generation)

å¦‚æœæƒ³è¦æ›¿æ›é€£æ¥çš„ç¶²è·¯çš„è©±å¯ä»¥ä½¿ç”¨

```sh
# æ›åˆ° localhost
solana config set --url localhost

# æ›åˆ° devnet
solana config set --url devnet

# æˆ–æ˜¯ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ç°¡å¯«

# æ›åˆ° localhost
solana config set -ul

# æ›åˆ° devnet
solana config set -ud
```

éš¨æ™‚æ³¨æ„è‡ªå·±çš„é€£æ¥ç¶²è·¯å¾ˆé‡è¦ï¼Œé¿å…ç”¨åˆ°å…¶ä»–ç’°å¢ƒé€ æˆå¥‡æ€ªçš„çµæœã€‚

é€™é‚Šæˆ‘å€‘å…ˆåˆ‡åˆ°devnetä¾†æ–¹ä¾¿ä¸‹é¢å…©å€‹æŒ‡ä»¤çš„æ“ä½œã€‚

ç•¶å‰çš„åœ°å€

```sh
solana address
```

å¸³æˆ¶è©³ç´°çš„è³‡è¨Š

```sh
solana account <ä¸Šé¢çš„åœ°å€>
```

å†ä¾†æˆ‘å€‘åˆ‡æ›åˆ°localhostä¾†é€²è¡Œè¨­ç½®

```sh
# åˆ‡æ›å›localnet
solana config set -ul

# åŸ·è¡Œæœ¬åœ°ç¯€é»
# å¦‚æœæ˜¯Windowsç”¨æˆ¶ï¼Œç›®å‰é‚„ä¸æ”¯æ´é€™å€‹æŒ‡ä»¤
solana-test-validator
```

ç•¶æœ¬åœ°ç¯€é»è·‘èµ·ä¾†çš„æ™‚å€™æˆ‘å€‘å¯ä»¥æ‹¿ä¸€äº›SOLçš„airdrop

```sh
solana aridrop 100
```

SOLé‡‘é¡

```sh
solana balance

# or

solana balance <åœ°å€>
```

å¦‚æœä¸€åˆ‡éƒ½é€²è¡Œå¾—å¾ˆé †åˆ©çš„è©±ï¼Œä½ ç›®å‰æ‡‰è©²æœƒæœ‰100SOLğŸ¤‘ (çš„æ¸¬è©¦ä»£å¹£ğŸ¥²)

## Anchor

æˆ‘å€‘å¯ä»¥ç”¨ä¸‹é¢æŒ‡ä»¤ä¾†ä½¿ç”¨Anchorå•Ÿå‹•ä¸€å€‹æ–°å°ˆæ¡ˆ

```sh
anchor init mysolanaapp

cd mysolanaapp
```

åœ¨é€™å€‹å°ˆæ¡ˆè£¡é¢æ‡‰è©²æœƒæ˜¯é•·å¾—åƒé€™æ¨£çš„çµæ§‹

```sh
.
â”œâ”€â”€ Anchor.toml # anchorçš„è¨­å®šæª”
â”œâ”€â”€ Cargo.toml # cargoçš„è¨­å®šæª”
â”œâ”€â”€ app # æˆ‘å€‘çš„å‰ç«¯codeæœƒåœ¨é€™é‚Š
â”œâ”€â”€ migrations # å¯ä»¥è¨­ç½®deploy script
â”œâ”€â”€ programs # Solana Program æœƒåœ¨é€™è£¡
â””â”€â”€ tests # å¯«æ¸¬è©¦çš„åœ°æ–¹
```

æˆ‘å€‘å…ˆä¾†çœ‹ä¸€ä¸‹ä»–å…§å»ºå¹«æˆ‘å€‘ç”¢å¥½çš„programã€‚

Anchorä½¿ç”¨äº†[eDSL](https://en.wikipedia.org/wiki/Domain-specific_language#:~:text=embedded%20domain%2Dspecific%20language%20(eDSL,methods%2C%20macros%20etc.))ï¼Œä»–ç°¡åŒ–äº†å¾ˆå¤šè¤‡é›œçš„åº•å±¤æ“ä½œï¼Œ
è®“codeè®Šçš„æ›´å®¹æ˜“è®€ã€‚

*programs/mysolanaapp/src/lib.rs*
```rust
use anchor_lang::prelude::*;

declare_id!("Fg6PaFpoGXkYsidMpWTK6W2BeZ7FEfcYkg476zPFsLnS");

#[program]
pub mod mysolanaapp {
    use super::*;
    // é€™å€‹æ˜¯ä½ programå®šç¾©çš„æ“ä½œ
    // ç›®å‰åªæœ‰ initialize å¯ä»¥æä¾›çµ¦ä½¿ç”¨è€…å‘¼å«
    pub fn initialize(ctx: Context<Initialize>) -> ProgramResult {
        Ok(())
    }
}
// é€™å€‹æ˜¯è¦å‘¼å«çš„åƒæ•¸è¨­ç½®ï¼Œé€™é‚Šæˆ‘å€‘åªæœ‰initializeçš„functionæœ‰ç”¨åˆ°å®ƒ
#[derive(Accounts)]
pub struct Initialize {}
```

é€™æ‡‰è©²æ˜¯anchorè£¡é¢æœ€åŸºæœ¬çš„programï¼Œé€™å€‹programç›®å‰åªæœ‰æä¾›`initialize`çš„æ“ä½œï¼Œä¸¦æ²’æœ‰ä»»ä½•dataçš„æ›´æ–°ã€‚

`Initialize`çš„structå®šç¾©contextï¼Œæˆ‘å€‘æ™šé»æœƒåœ¨é€™é‚Šå¤šä»‹ç´¹ä¸€äº›ã€‚

è¦ç·¨è­¯é€™å€‹programï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨

```sh
anchor build
```

ç•¶ä½ ç·¨è­¯å®Œæˆå¾Œï¼Œä½ æ‡‰è©²æœƒçœ‹åˆ°ä¸€å€‹æ–°çš„è³‡æ–™å¤¾ `target`ã€‚å…¶ä¸­æœ‰ä¸€å€‹å¾ˆé‡è¦çš„æª”æ¡ˆæœƒåœ¨
*target/idl/mysolanaapp.json*ã€‚é€™å€‹æ˜¯[IDL](https://en.wikipedia.org/wiki/Interface_description_language)ã€‚

å¯ä»¥æŠŠIDLçœ‹ä½œæ˜¯Solanaçš„[ABI](https://docs.soliditylang.org/en/v0.5.3/abi-spec.html)ï¼Œå°±æ˜¯ä¸€å€‹å®šç¾©queryä»‹é¢çš„ä¸€å€‹æè¿°æª”æ¡ˆã€‚

å¦å¤–æˆ‘å€‘é‚„å¯ä»¥æ¸¬è©¦æˆ‘å€‘çš„Programã€‚

*tests/mysolanaapp.js*
```js
const anchor = require('@project-serum/anchor');

describe('mysolanaapp', () => {

  // Configure the client to use the local cluster.
  anchor.setProvider(anchor.Provider.env());

  it('Is initialized!', async () => {
    // Add your test here.
    const program = anchor.workspace.Mysolanaapp;
    const tx = await program.rpc.initialize();
    console.log("Your transaction signature", tx);
  });
});
```

é€™é‚Šæœ‰å¹¾å€‹æ±è¥¿éœ€è¦ç‰¹åˆ¥ä»‹ç´¹ä¸€ä¸‹ã€‚

### Provider

é€™å€‹æ˜¯å°solanaé€£ç·šçš„ä¸€å€‹æŠ½è±¡ï¼Œæ˜¯ç”±connection, walletå’Œpreflight commitmentçµ„æˆã€‚

åœ¨æ¸¬è©¦è£¡é¢anchoræœƒç”¨`anchor.Provider.env`ä¾†è¨­ç½®providerï¼Œä¸éå¦‚æœæˆ‘å€‘ç¾åœ¨æ˜¯è¦å¯«client appçš„è©±ï¼Œæœƒéœ€è¦æ”¹ç”¨userçš„solanaéŒ¢åŒ…ä¾†è¨­ç½®ã€‚

### Program

é€™æ˜¯å°`Provider`å’Œ`idl`ä»¥åŠ`programID`çš„æŠ½è±¡ã€‚ä¸¦ä¸”å®ƒå…è¨±ä½ å‘¼å«`RPC`æ–¹æ³•ã€‚

è·Ÿproviderä¸€æ¨£ï¼Œæˆ‘å€‘åœ¨client appçš„è¨­ç½®ä¹Ÿéœ€è¦æ³¨æ„ã€‚

ç•¶æˆ‘å€‘æº–å‚™å¥½é€™å…©å€‹æ±è¥¿å¾Œï¼Œæˆ‘å€‘å°±å¯ä»¥é–‹å§‹å’Œprogramäº¤äº’ã€‚å› ç‚ºæˆ‘å€‘åœ¨programè£¡é¢æœ‰`initialize`ï¼Œæ‰€ä»¥æˆ‘å€‘å¯ä»¥ä½¿ç”¨

```js
const tx = await program.rpc.initialize();
```

ä¾†ç›´æ¥èˆ‡programäº’å‹•ï¼Œè€Œä½¿ç”¨è¦å‰‡çš„è©±é€šå¸¸éƒ½æ˜¯`program.rpc.functionName`

æ™šé»çœ‹æ›´å¤šä¾‹å­çš„æ™‚å€™æˆ‘å€‘å¯ä»¥æœ‰æ›´æ·±åˆ»çš„é«”æœƒã€‚ç¾åœ¨æˆ‘å€‘å…ˆä¾†åŸ·è¡Œçœ‹çœ‹é€™å€‹testã€‚

```sh
anchor test
```

æ²’æ„å¤–çš„è©±ä»–æœƒå™´ä¸€å€‹è­¦å‘Šï¼Œè·Ÿä½ èªªä½ çš„ctxæ²’æœ‰ç”¨ï¼Œè¦æ”¹æˆ_ctxï¼Œé€™æ¨£é€™é‚Šçš„åŸºæœ¬æ“ä½œå°±ç®—æ˜¯å®Œæˆäº†ã€‚æˆ‘å€‘æ¥ä¸‹ä¾†è¦ä¾†æ‰“é€ æˆ‘å€‘ç¬¬ä¸€å€‹Hello World

## å»ºç½®Hello World

é€™é‚Šæ‹¿å‰›å‰›çš„å°ˆæ¡ˆä¾†ä¿®æ”¹ï¼Œæˆ‘å€‘æœƒåšä¸€å€‹è¨ˆæ•¸å™¨ï¼Œæ¯æ¬¡è¢«å‘¼å«çš„æ™‚å€™éƒ½æœƒ+1ã€‚

*programs/mysolanaapp/src/lib.rs*
```rust
use anchor_lang::prelude::*;

declare_id!("Fg6PaFpoGXkYsidMpWTK6W2BeZ7FEfcYkg476zPFsLnS");

#[program]
mod mysolanaapp {
    use super::*;

    // å› ç‚ºSolana account modelçš„é—œä¿‚ï¼Œæˆ‘å€‘éœ€è¦å‰µé€ ä¸€å€‹å¸³æˆ¶ä¾†å„²å­˜
    // æˆ‘å€‘çš„è¨ˆæ•¸çµæœï¼Œè€Œä¸æ˜¯ç›´æ¥æŠŠæ•¸å­—å­˜åœ¨åˆç´„ä¸­
    // é€™é‚Šæˆ‘å€‘å®šç¾©ä¸€å€‹createçš„æ“ä½œï¼Œè®“å¸³æˆ¶èƒ½åœ¨é€™å€‹åˆç´„å…§è¢«åˆå§‹åŒ–
    pub fn create(ctx: Context<Create>) -> ProgramResult {
        let base_account = &mut ctx.accounts.base_account;
        base_account.count = 0;
        Ok(())
    }

    // é€™å€‹æ“ä½œå°±æ˜¯+1çš„åœ°æ–¹ï¼Œé€™é‚Šæœƒå–clientå‚³éä¾†çš„è¨ˆæ•¸ç”¨çš„å¸³æˆ¶
    // ç„¶å¾Œå°ä»–+1
    pub fn increment(ctx: Context<Increment>) -> ProgramResult {
        let base_account = &mut ctx.accounts.base_account;
        base_account.count += 1;
        Ok(())
    }
}

// é€™å€‹æ˜¯createæ“ä½œæ™‚æ‰€éœ€è¦çš„ä¸€äº›åƒæ•¸
#[derive(Accounts)]
pub struct Create<'info> {
    #[account(init, payer = user, space = 16 + 16)]
    pub base_account: Account<'info, BaseAccount>,
    pub user: AccountInfo<'info>,
    pub system_program: AccountInfo<'info>,
}

// é€™å€‹æ˜¯incrementæ‰€éœ€è¦çš„åƒæ•¸
#[derive(Accounts)]
pub struct Increment<'info> {
    #[account(mut)]
    pub base_account: Account<'info, BaseAccount>,
}

// å„²å­˜æ•¸é‡çš„çµæ§‹é«”
#[account]
pub struct BaseAccount {
    pub count: u64,
}
```

åœ¨é€™å€‹programå…§æœ‰å…©å€‹instructionï¼Œ`create`å’Œ`increment`ã€‚

ä¸€èˆ¬æˆ‘å€‘åœ¨æ–°å»ºinsturctionæ™‚éƒ½æœƒéœ€è¦å‚³å…¥ä¸€å€‹Contextçš„çµæ§‹ï¼Œä¸»è¦å°±æ˜¯å®šç¾©é€™å€‹instructionæœƒç”¨åˆ°ä»€éº¼æ±è¥¿ã€‚

`#[account(...)]` æ˜¯ä¸€å€‹å°æ–¼acccountçš„åŠ å¼·æè¿°ï¼Œä»–æœƒå®šç¾©é€™å€‹accountåœ¨é€™å€‹instructionçš„é™åˆ¶ï¼Œå¦‚æœå‚³å…¥çš„accountä¸æ»¿è¶³é€™äº›æ•˜è¿°ï¼Œé‚£é€™å€‹instructionå°±æœƒå¤±æ•—ã€‚

æ‰€ä»¥ä»¥é€™å€‹ä¾‹å­ä¾†èªªï¼Œæˆ‘å€‘ä¸¦æ²’æœ‰å®šç¾©èª°æ“æœ‰ä»€éº¼å¸³æˆ¶ï¼Œä¹Ÿæ²’æœ‰ç›¸é—œçš„é©—è­‰æ¬Šé™ï¼Œä¹Ÿå°±æ˜¯èªªåœ¨æˆ‘å€‘ç¾åœ¨çš„programå…§ï¼ŒAliceæ˜¯å¯ä»¥æ‹¿Bobå‰µå‡ºçš„accountçš„ã€‚

å®Œæˆä¹‹å¾Œè¨˜å¾—å†ä¸‹ä¸€æ¬¡buildæŒ‡ä»¤

```sh
anchor build
```

æ¥ä¸‹ä¾†æˆ‘å€‘ä¾†å¯«test

*tests/mysolanaapp.js*

```js
const assert = require("assert");
const anchor = require("@project-serum/anchor");
const { SystemProgram } = anchor.web3;

describe("mysolanaapp", () => {
  /* create and set a Provider */
  const provider = anchor.Provider.env();
  anchor.setProvider(provider);

  it("å‰µå»ºä¸€å€‹å¸³æˆ¶", async () => {
    // å®šç¾©programæ˜¯æˆ‘å€‘çš„mysolanaapp
    const program = anchor.workspace.Mysolanaapp;
    // é€™é‚Šç”¨å…§å»ºçš„éš¨æ„å‰µä¸€å€‹
    const baseAccount = anchor.web3.Keypair.generate();
    // é€™é‚Šè¦å‰‡è·Ÿä¹‹å‰èªªçš„ä¸€æ¨£ï¼Œå¯ä»¥ä½¿ç”¨ program.rpc.<instruction-name-in-program> ä¾†å‘¼å«
    await program.rpc.create({
      accounts: {
        // é€™é‚Šçš„è¼¸å…¥æœƒè·Ÿæˆ‘å€‘åœ¨programè£¡é¢å®šç¾©çš„contextæ˜¯ä¸€æ¨£çš„
        baseAccount: baseAccount.publicKey,
        user: provider.wallet.publicKey,
        systemProgram: SystemProgram.programId,
      },
      // baseAccountæœƒéœ€è¦ç°½åæ˜¯å› ç‚ºä»–è¦è¢«å‰µå»º
      // ä¸å¤ªç†Ÿæ‚‰çš„äººå¯ä»¥å»æˆ‘çš„solana-web3-demoçš„touréä¸€ä¸‹æ¦‚å¿µ
      signers: [baseAccount],
    });

    // é©—è­‰æˆ‘å€‘å‰µå‡ºä¾†çš„accountå¯ä»¥æˆåŠŸè¢«è®€å–è³‡æ–™
    const account = await program.account.baseAccount.fetch(baseAccount.publicKey);
    console.log('Count 0: ', account.count.toString())
    assert.ok(account.count.toString() == 0);
    _baseAccount = baseAccount;

  });

  it("å¢åŠ ", async () => {
    // é€™é‚Šå»¶çºŒæˆ‘å€‘å‰›å‰›å‰µå‡ºä¾†çš„account
    const baseAccount = _baseAccount;
    // ä¸€æ¨£å®šç¾©æ˜¯æˆ‘å€‘çš„program
    const program = anchor.workspace.Mysolanaapp;
    // é€™é‚Šè¦å‰‡è·Ÿä¹‹å‰èªªçš„ä¸€æ¨£ï¼Œå¯ä»¥ä½¿ç”¨ program.rpc.<instruction-name-in-program> ä¾†å‘¼å«
    await program.rpc.increment({
      accounts: {
        // å¦‚åŒæˆ‘å€‘programå®šç¾©çš„incrementçš„context
        baseAccount: baseAccount.publicKey,
      },
    });

    // é©—è­‰æˆ‘å€‘çš„+1æœ‰æ²’æœ‰æˆåŠŸ
    const account = await program.account.baseAccount.fetch(baseAccount.publicKey);
    console.log('Count 1: ', account.count.toString())
    assert.ok(account.count.toString() == 1);
  });
});
```

åœ¨æˆ‘å€‘åŸ·è¡Œå®ƒä¹‹å‰ï¼Œæˆ‘å€‘æœƒéœ€è¦çŸ¥é“æˆ‘å€‘çš„program IDï¼Œæˆ‘å€‘å¯ä»¥é€éä¸‹é¢çš„æŒ‡ä»¤å¾—åˆ°å®ƒ

```
solana address -k target/deploy/mysolanaapp-keypair.json
```

ä¸¦ä¸”åœ¨

*mysolanaapp/src/lib.rs*

```rust
// æŠŠåŸæœ¬åœ¨è£¡é¢çš„æ•¸å€¼æ›æˆæˆ‘å€‘çš„program id
declare_id!("your-program-id");
```

å’Œ

*Anchor.toml*

```toml
[programs.localnet]
mysolanaapp = "your-program-id"
```

ä¸Šé¢å…©æ­¥é©Ÿéƒ½å®Œæˆä¹‹å¾Œï¼Œå°±å¯ä»¥ä¾†è©¦è©¦ä»–äº†

```
anchor test
```

æ¥ä¸‹ä¾†æˆ‘å€‘ä¾†å¯«å‰ç«¯

æˆ‘å€‘å…ˆå›åˆ°æˆ‘å€‘çš„mysolanaappçš„anchorå°ˆæ¡ˆæ ¹ç›®éŒ„ï¼Œç”¨

```sh
npx create-react-app app
```

ä¾†è¦†è“‹åŸæœ¬ä»–çµ¦æˆ‘å€‘çš„appè³‡æ–™å¤¾ï¼Œæ¥ä¸‹ä¾†

```sh
cd app

npm install @project-serum/anchor @solana/web3.js
```

å†ä¾†å› ç‚ºæˆ‘å€‘çš„å‰ç«¯æœƒç”¨åˆ°[Solana Wallet Adapter](https://github.com/solana-labs/wallet-adapter)ï¼Œé€™å€‹åº«å¯ä»¥å¹«æˆ‘å€‘è™•ç†ä½¿ç”¨è€…çš„éŒ¢åŒ…ï¼Œè€Œä¸”è£¡é¢é‚„é›†æˆäº†å¾ˆå¤šå…¶ä»–å¤§å®—çš„éŒ¢åŒ…ã€‚ä»–éœ€è¦çš„å¥—ä»¶æœ‰ä¸‹é¢é€™äº›ï¼Œæˆ‘å€‘ä¹ŸæŠŠä»–è£èµ·ä¾†ã€‚

```sh
npm install @solana/wallet-adapter-react \
@solana/wallet-adapter-react-ui @solana/wallet-adapter-wallets \
@solana/wallet-adapter-base
```

è£å®Œä¹‹å¾Œæˆ‘å€‘æŠŠIDLæª”æ¡ˆè¤‡è£½éä¾†

```
cp ../target/idl/mysolanaapp.json src/idl.json
```

æ¥ä¸‹ä¾†æˆ‘å€‘ä¾†æ”¹å‰ç«¯çš„é é¢

*app/src/App.js*

```js
import './App.css';
import { useState } from 'react';
import { Connection, PublicKey } from '@solana/web3.js';
import {
  Program, Provider, web3
} from '@project-serum/anchor';
import idl from './idl.json';

import { getPhantomWallet } from '@solana/wallet-adapter-wallets';
import { useWallet, WalletProvider, ConnectionProvider } from '@solana/wallet-adapter-react';
import { WalletModalProvider, WalletMultiButton } from '@solana/wallet-adapter-react-ui';

const wallets = [
  /* view list of available wallets at https://github.com/solana-labs/wallet-adapter#wallets */
  getPhantomWallet()
]

const { SystemProgram, Keypair } = web3;
/* create an account  */
const baseAccount = Keypair.generate();
const opts = {
  preflightCommitment: "processed"
}
const programID = new PublicKey(idl.metadata.address);

function App() {
  const [value, setValue] = useState(null);
  const wallet = useWallet();

  async function getProvider() {
    /* create the provider and return it to the caller */
    /* network set to local network for now */
    const network = "http://127.0.0.1:8899";
    const connection = new Connection(network, opts.preflightCommitment);

    const provider = new Provider(
      connection, wallet, opts.preflightCommitment,
    );
    return provider;
  }

  async function createCounter() {
    const provider = await getProvider()
    /* create the program interface combining the idl, program ID, and provider */
    const program = new Program(idl, programID, provider);
    try {
      /* interact with the program via rpc */
      await program.rpc.create({
        accounts: {
          baseAccount: baseAccount.publicKey,
          user: provider.wallet.publicKey,
          systemProgram: SystemProgram.programId,
        },
        signers: [baseAccount]
      });

      const account = await program.account.baseAccount.fetch(baseAccount.publicKey);
      console.log('account: ', account);
      setValue(account.count.toString());
    } catch (err) {
      console.log("Transaction error: ", err);
    }
  }

  async function increment() {
    const provider = await getProvider();
    const program = new Program(idl, programID, provider);
    await program.rpc.increment({
      accounts: {
        baseAccount: baseAccount.publicKey
      }
    });

    const account = await program.account.baseAccount.fetch(baseAccount.publicKey);
    console.log('account: ', account);
    setValue(account.count.toString());
  }

  if (!wallet.connected) {
    /* If the user's wallet is not connected, display connect wallet button. */
    return (
      <div style={{ display: 'flex', justifyContent: 'center', marginTop:'100px' }}>
        <WalletMultiButton />
      </div>
    )
  } else {
    return (
      <div className="App">
        <div>
          {
            !value && (<button onClick={createCounter}>Create counter</button>)
          }
          {
            value && <button onClick={increment}>Increment counter</button>
          }

          {
            value && value >= Number(0) ? (
              <h2>{value}</h2>
            ) : (
              <h3>Please create the counter.</h3>
            )
          }
        </div>
      </div>
    );
  }
}

/* wallet configuration as specified here: https://github.com/solana-labs/wallet-adapter#setup */
const AppWithProvider = () => (
  <ConnectionProvider endpoint="http://127.0.0.1:8899">
    <WalletProvider wallets={wallets} autoConnect>
      <WalletModalProvider>
        <App />
      </WalletModalProvider>
    </WalletProvider>
  </ConnectionProvider>
)

export default AppWithProvider;
```

æ”¹å®Œä¹‹å¾Œï¼Œæˆ‘å€‘æœƒéœ€è¦è¨˜å¾—æŠŠphantomè£¡é¢çš„networkä¹Ÿæ”¹æˆlocalnet

![1](https://res.cloudinary.com/practicaldev/image/fetch/s--TUVVaCuV--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/dw09ddfv8sf96px7clc5.png)
![2](https://res.cloudinary.com/practicaldev/image/fetch/s--7fFmF46U--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/b8uxbjhqhnvnuheal50v.png)

å†ä¾†æˆ‘å€‘è¦ä¾†å¹«phontomçš„åœ°å€æ‹¿ä¸€é»airdrop

![address](https://res.cloudinary.com/practicaldev/image/fetch/s--A6wOufNS--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/746cr3yu2gprby424w1w.png)

é»ä¸€ä¸‹é€™é‚Šå°±æœƒè¤‡è£½äº†ï¼Œæ¥ä¸‹ä¾†å›åˆ°command lineï¼Œè¨˜å¾—ä½ çš„solana-test-validatorè¦é–‹èµ·ä¾†!

```
solana airdrop 10 <phantomåœ°å€>
```

å›åˆ°æˆ‘å€‘çš„å‰ç«¯å°ˆæ¡ˆ(app/)åŸ·è¡Œ

```
npm start
```

ä½ æœƒç™¼ç¾ç•¶ä½ å®Œæˆæ“ä½œå†æ¬¡åˆ·æ–°é é¢æ™‚ï¼Œå‰›å‰›ç”¢ç”Ÿçš„åœ°å€å°±ä¸è¦‹äº†ã€‚é€™æ˜¯å› ç‚ºæˆ‘å€‘æ¯æ¬¡éƒ½æ˜¯éš¨æ©Ÿçš„ï¼Œæ‰€ä»¥è¨ˆæ•¸å™¨çš„åœ°å€å’Œæˆ‘å€‘çš„å¸³è™Ÿåœ°å€æ²’æœ‰é—œè¯æ€§ã€‚æƒ³è¦è§£æ±ºé€™å€‹äº‹æƒ…åŸä½œè€…æœ‰æä¾›ä¸€å€‹[gist](https://gist.github.com/dabit3/7cbd18b8bc4b495c4831f8674902eb42)ã€‚

æˆ‘è‡ªå·±å‰‡æ˜¯å»ºè­°ä½ èƒ½å¤ è¨­è¨ˆä¸€å€‹è¨ˆæ•¸å™¨å¸³è™Ÿå’Œä½¿ç”¨è€…å¸³è™Ÿçš„é—œè¯ï¼Œ
å¯ä»¥ä½¿ç”¨[findProgramAddress](https://solana-labs.github.io/solana-web3.js/classes/PublicKey.html#findProgramAddress)ï¼Œé€™å¯ä»¥å‚³seedä¸¦ä¸”è¨ˆç®—PDAï¼Œæœ‰èˆˆè¶£çš„æœ‹å‹å¯ä»¥å¾€é€™æ–¹é¢ç ”ç©¶ä¸€ä¸‹ã€‚

## Hello World part 2

å†ä¾†æˆ‘å€‘æœƒå»ºä¸€å€‹èƒ½å¤ å„²å­˜è¨Šæ¯çš„program, é€™é‚Šä½ å¯ä»¥ç”¨åŸæœ¬çš„å°ˆæ¡ˆç¹¼çºŒæ”¹ï¼Œä¹Ÿå¯ä»¥å‰µä¸€å€‹æ–°çš„ã€‚

```rust
use anchor_lang::prelude::*;

declare_id!("Fg6PaFpoGXkYsidMpWTK6W2BeZ7FEfcYkg476zPFsLnS");

#[program]
pub mod helloworld2 {
    use super::*;
    // initçš„æ“ä½œ
    pub fn initialize(ctx: Context<Initialize>, data: String) -> ProgramResult {
        let base_account = &mut ctx.accounts.base_account;
        let copy = data.clone();
        base_account.data = data;
        base_account.data_list.push(copy);
        Ok(())
    }
    // æ›´æ–°è³‡æ–™
    pub fn update(ctx: Context<Update>, data: String) -> ProgramResult {
        let base_account = &mut ctx.accounts.base_account;
        let copy = data.clone();
        base_account.data = data;
        base_account.data_list.push(copy);
        Ok(())
    }
}

#[derive(Accounts)]
pub struct Initialize<'info> {
    #[account(init, payer = user, space = 64 + 64)]
    pub base_account: Account<'info, BaseAccount>,
    pub user: AccountInfo<'info>,
    pub system_program: AccountInfo<'info>,
}

#[derive(Accounts)]
pub struct Update<'info> {
    #[account(mut)]
    pub base_account: Account<'info, BaseAccount>,
}

// å„²å­˜è¨Šæ¯çš„çµæ§‹
#[account]
pub struct BaseAccount {
    // ç•¶å‰è³‡æ–™
    pub data: String,
    // æ­·å²è³‡æ–™
    pub data_list: Vec<String>,
}
```

é€™é‚Šçš„spaceæ˜¯64+64ï¼Œé€™å€‹å¤§å°æ˜¯å¯ä»¥è‡ªè¨‚çš„ï¼Œå®Œå…¨ä¾ç…§è‡ªå·±çš„éœ€æ±‚ä¾†çµ¦ã€‚ä¸éä¸€æ—¦å›ºå®šä¹‹å¾Œä¹‹å¾Œè¦æ›åˆ°æ›´å¤§çš„spaceçš„accountæœƒéœ€è¦å¤šå¯«migrationã€‚

æ¥ä¸‹ä¾†æ˜¯test

```js
const assert = require("assert");
const anchor = require("@project-serum/anchor");
const { SystemProgram } = anchor.web3;

describe("Mysolanaapp", () => {
  const provider = anchor.Provider.env();
  anchor.setProvider(provider);
  it("It initializes the account", async () => {
    const program = anchor.workspace.Mysolanaapp;
    const baseAccount = anchor.web3.Keypair.generate();
    await program.rpc.initialize("Hello World", {
      accounts: {
        baseAccount: baseAccount.publicKey,
        user: provider.wallet.publicKey,
        systemProgram: SystemProgram.programId,
      },
      signers: [baseAccount],
    });

    const account = await program.account.baseAccount.fetch(baseAccount.publicKey);
    console.log('Data: ', account.data);
    assert.ok(account.data === "Hello World");
    _baseAccount = baseAccount;

  });

  it("Updates a previously created account", async () => {
    const baseAccount = _baseAccount;
    const program = anchor.workspace.Mysolanaapp;

    await program.rpc.update("Some new data", {
      accounts: {
        baseAccount: baseAccount.publicKey,
      },
    });

    const account = await program.account.baseAccount.fetch(baseAccount.publicKey);
    console.log('Updated data: ', account.data)
    assert.ok(account.data === "Some new data");
    console.log('all account data:', account)
    console.log('All data: ', account.dataList);
    assert.ok(account.dataList.length === 2);
  });
});
```

```
anchor test
```

æœ€å¾Œæ˜¯å‰ç«¯çš„code

```js
import './App.css';
import { useState } from 'react';
import { Connection, PublicKey } from '@solana/web3.js';
import { Program, Provider, web3 } from '@project-serum/anchor';
import idl from './idl.json';

import { getPhantomWallet } from '@solana/wallet-adapter-wallets';
import { useWallet, WalletProvider, ConnectionProvider } from '@solana/wallet-adapter-react';
import { WalletModalProvider, WalletMultiButton } from '@solana/wallet-adapter-react-ui';

const wallets = [ getPhantomWallet() ]

const { SystemProgram, Keypair } = web3;
const baseAccount = Keypair.generate();
const opts = {
  preflightCommitment: "processed"
}
const programID = new PublicKey(idl.metadata.address);

function App() {
  const [value, setValue] = useState('');
  const [dataList, setDataList] = useState([]);
  const [input, setInput] = useState('');
  const wallet = useWallet()

  async function getProvider() {
    /* create the provider and return it to the caller */
    /* network set to local network for now */
    const network = "http://127.0.0.1:8899";
    const connection = new Connection(network, opts.preflightCommitment);

    const provider = new Provider(
      connection, wallet, opts.preflightCommitment,
    );
    return provider;
  }

  async function initialize() {
    const provider = await getProvider();
    /* create the program interface combining the idl, program ID, and provider */
    const program = new Program(idl, programID, provider);
    try {
      /* interact with the program via rpc */
      await program.rpc.initialize("Hello World", {
        accounts: {
          baseAccount: baseAccount.publicKey,
          user: provider.wallet.publicKey,
          systemProgram: SystemProgram.programId,
        },
        signers: [baseAccount]
      });

      const account = await program.account.baseAccount.fetch(baseAccount.publicKey);
      console.log('account: ', account);
      setValue(account.data.toString());
      setDataList(account.dataList);
    } catch (err) {
      console.log("Transaction error: ", err);
    }
  }

  async function update() {
    if (!input) return
    const provider = await getProvider();
    const program = new Program(idl, programID, provider);
    await program.rpc.update(input, {
      accounts: {
        baseAccount: baseAccount.publicKey
      }
    });

    const account = await program.account.baseAccount.fetch(baseAccount.publicKey);
    console.log('account: ', account);
    setValue(account.data.toString());
    setDataList(account.dataList);
    setInput('');
  }

  if (!wallet.connected) {
    return (
      <div style={{ display: 'flex', justifyContent: 'center', marginTop:'100px' }}>
        <WalletMultiButton />
      </div>
    )
  } else {
    return (
      <div className="App">
        <div>
          {
            !value && (<button onClick={initialize}>Initialize</button>)
          }

          {
            value ? (
              <div>
                <h2>Current value: {value}</h2>
                <input
                  placeholder="Add new data"
                  onChange={e => setInput(e.target.value)}
                  value={input}
                />
                <button onClick={update}>Add data</button>
              </div>
            ) : (
              <h3>Please Inialize.</h3>
            )
          }
          {
            dataList.map((d, i) => <h4 key={i}>{d}</h4>)
          }
        </div>
      </div>
    );
  }
}

const AppWithProvider = () => (
  <ConnectionProvider endpoint="http://127.0.0.1:8899">
    <WalletProvider wallets={wallets} autoConnect>
      <WalletModalProvider>
        <App />
      </WalletModalProvider>
    </WalletProvider>
  </ConnectionProvider>
)

export default AppWithProvider;
```

å†ä¾†è¨˜å¾—ç¢ºå®šä½ çš„ `solana-test-validator` æœ‰è·‘èµ·ä¾†ã€‚åŸ·è¡Œ

```
anchor build

anchor deploy
```

è¨˜å¾—ä¸€æ¨£è¦æŠŠidlæª”æ¡ˆè¤‡è£½åˆ°appçš„srcä¸‹é¢

```
npm start
```

## Deploying to devnet

æˆ‘å€‘ä¹Ÿå¯ä»¥æŠŠé€™å€‹programéƒ¨ç½²åˆ°devnetä¸Šé¢

1. å…ˆæŠŠsolana configé€£æ¥åˆ°devnet

```
solana config set -ud
```

2. æ›´æ–°ä½ çš„phantomé€£æ¥çš„ç¶²è·¯åˆ°devnet

3. æ‰“é–‹ **Anchor.toml**ï¼ŒæŠŠlocalnetæ”¹æˆdevnet

4. é‡æ–°buildä¸€æ¬¡programä¸¦ä¸”ç¢ºèªä¸€ä¸‹program idæ˜¯ä¸æ˜¯éƒ½æœ‰æ”¹å¥½

5. é‡æ–°ä¸‹ä¸€æ¬¡deployæŒ‡ä»¤ï¼Œé€™æ¬¡æˆ‘å€‘å°±æœƒéƒ¨ç½²åˆ°devnetä¸Šäº†

6. è¨˜å¾—è¦ä¿®æ”¹App.jså…§çš„é€£æ¥ç¶²è·¯

```js
// ä¿®æ”¹å‰
<ConnectionProvider endpoint="http://127.0.0.1:8899">

// ä¿®æ”¹å¾Œ
import {
  ...,
  clusterApiUrl
} from '@solana/web3';

const network = clusterApiUrl('devnet');

<ConnectionProvider endpoint={network}>
```

